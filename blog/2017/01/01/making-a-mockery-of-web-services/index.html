<!doctype html><html lang=en><head><title>Making a mockery of web services :: Nick Ebbitt</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="In October 2016 I gave my first public talk at the Manchester Java Community (MJC). The talk took the form of a 15 minute lightning talk and this blog provides the detail of what I discussed to support the slides.
Abstract With the help of WireMock we will explore how to create reliable and repeatable end-to-end tests for an application that depends on an external web service or HTTP-based API."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://nickebbitt.com/blog/2017/01/01/making-a-mockery-of-web-services/><link rel=stylesheet href=https://nickebbitt.com/styles.css><link rel="shortcut icon" href=https://nickebbitt.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://nickebbitt.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta name=twitter:site content="nickebbitt"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Making a mockery of web services"><meta property="og:description" content="In October 2016 I gave my first public talk at the Manchester Java Community (MJC). The talk took the form of a 15 minute lightning talk and this blog provides the detail of what I discussed to support the slides.
Abstract With the help of WireMock we will explore how to create reliable and repeatable end-to-end tests for an application that depends on an external web service or HTTP-based API."><meta property="og:url" content="https://nickebbitt.com/blog/2017/01/01/making-a-mockery-of-web-services/"><meta property="og:site_name" content="Nick Ebbitt"><meta property="og:image" content="https://nickebbitt.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2017-01-01 00:00:00 +0000 UTC"></head><body class=orange><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/posts><div class=logo>Nick Ebbitt</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/about>About</a></li><li><a href=/contact>Contact</a></li><li><a href=/posts>Posts</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>About</a></li><li><a href=/contact>Contact</a></li><li><a href=/posts>Posts</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://nickebbitt.com/blog/2017/01/01/making-a-mockery-of-web-services/>Making a mockery of web services</a></h1><div class=post-meta><time class=post-date>2017-01-01 ::</time></div><div class=post-content><div><p>In October 2016 I gave my first public talk at the Manchester Java Community (MJC). The talk took the form of a 15 minute lightning talk and this blog provides the detail of what I discussed to support the <a href=https://speakerdeck.com/nickebbitt/making-a-mockery-of-web-services>slides</a>.</p><h1 id=abstract>Abstract<a href=#abstract class=hanchor arialabel=Anchor>&#8983;</a></h1><p>With the help of <a href=http://wiremock.org/>WireMock</a> we will explore how to create reliable and repeatable end-to-end tests for an application that depends on an external web service or HTTP-based API.</p><h2 id=the-problem>The Problem<a href=#the-problem class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Until around 5 years ago all my experience was heavily focused in the client/server world of Oracle RDBMS and Oracle Forms. I then started working on web applications that followed a more three tiered architecture. These applications have generally followed the same pattern, a database (usually Oracle) exposed via a HTTP-based web service that is consumed by a HTML/JavaScript based user interface.</p><p>The most recent system of this nature that I have worked on was a mobile platform to provide integration between mobile devices and a &ldquo;backend&rdquo; HTTP-based web service. The mobile platform was cloud based exposing HTTP endpoints to be consumed by the mobile clients.</p><p>We chose to architect the system to allow us to follow a Continuous Delivery (CD) approach using blue/green deployments. To allow us to deliver the system this way it was essential that we could run automated acceptance tests to provide us with the confidence that we had a system that was always releasable.</p><p>This blog post explores the tools & techniques used to approach this problem.</p><h2 id=define-mock>Define: Mock<a href=#define-mock class=hanchor arialabel=Anchor>&#8983;</a></h2><p>First off we&rsquo;ll cover some of the core ideas related to testing.</p><p>According to <a href="https://www.google.co.uk/webhp?sourceid=chrome-instant&ion=1&espv=2&ie=UTF-8#q=define%3A%20mock">Google</a>, to <em>mock</em> something is to&mldr;</p><blockquote><p>&mldr;make a replica or imitation of something.</p></blockquote><p>This definition sets us on the right path to understanding why we may want to mock something.</p><p>In relation to software engineering and specifically object oriented (OO) programming, <a href=http://martinfowler.com/articles/mocksArentStubs.html>Martin Fowler</a> suggest that mocks are&mldr;</p><blockquote><p>&mldr;special case objects that mimic real objects for testing.</p></blockquote><p>I think it&rsquo;s important to consider mocks more generally than just in applied to objects in the OO sense. A mock can be used for various types internal or external dependencies of a software application given the right tools & techniques for the job.</p><h3 id=why-use-mocks>Why use mocks?<a href=#why-use-mocks class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Mocks help us to write tests that are deterministic and repeatable. They provide a way of controlling the behaviour of dependencies that the object (or system) under test is collaborating or interacting with.</p><p>This control allows us to model the various scenarios or use-cases necessary to prove that the software meets the acceptance criteria.</p><h3 id=when-to-mock>When to mock?<a href=#when-to-mock class=hanchor arialabel=Anchor>&#8983;</a></h3><p>It is likely that during the development of an application you will be writing different types of tests with the intention of increasing the confidence that the changes you are developing are correct.</p><p><img src=testing-pyramid.png alt="Testing Pyramid"></p><p>This will usually start at the lowest level with unit tests in which you’ll be aiming to test a single unit of your application such as an instance of a single class. If the object you are testing collaborates with another object then using a design pattern such as <a href=https://en.wikipedia.org/wiki/Dependency_injection>dependency injection</a> and a mocking framework (e.g. <a href=http://site.mockito.org/>Mockito</a>) you will be able to inject a mock of the collaborator into the unit you are testing.</p><p>Similarly, if you are testing at a higher up the pyramid and looking to prove the correctness of a subsystem or the application as a whole then it may be desirable to mock the application’s external dependencies such as a database, a queue, or a web service.</p><p>It’s important to note I believe mocks are very useful but are not a replacement for testing against the “real” thing. This is still necessary, whether automated or manual, and should definitely be part of an overall testing strategy.</p><h3 id=mocking-web-services>Mocking web services<a href=#mocking-web-services class=hanchor arialabel=Anchor>&#8983;</a></h3><p>It’s common for an application to depend on an external HTTP-based web service. The dependency could be external to the company and controlled by a 3rd party e.g. Twitter.</p><p><img src=3rd-party.png alt=3rd-party></p><p>It could be a separate service from within the same organisation but controlled by a different team. It is quite common for microservices to communicate over HTTP.</p><p><img src=microservices.png alt=microservices></p><h2 id=introducing-wiremock>Introducing WireMock<a href=#introducing-wiremock class=hanchor arialabel=Anchor>&#8983;</a></h2><p>There are various tools or frameworks available that support the mocking of HTTP-based APIs & web services. WireMock is one such framework that we will explore in more detail having used to good effect to support the development and automated testing of the mobile platform described in the intro.</p><p><a href=http://wiremock.org/>WireMock</a> was created in 2011 by <a href=http://www.tomakehurst.com/about/>Tom Akehurst</a>, a software engineer based in the south of England.</p><p>The framework is mature (v2.4.1 at the time of writing), <a href=https://github.com/tomakehurst/wiremock>open source</a> and hosted on GitHub.</p><p>The documentation for WireMock is very good providing useful descriptions of the available features and plenty of examples to get you started.</p><h3 id=deployment>Deployment<a href=#deployment class=hanchor arialabel=Anchor>&#8983;</a></h3><p>In its simplest form WireMock comes as a runnable JAR that can be started from the command line. This mode has proven to be very useful during development providing a reliable web service running on your local machine to develop changes against.</p><pre tabindex=0><code>$ java -jar wiremock-standalone-2.1.1.jar --port 9999
</code></pre><p>Alternatively, WireMock can be deployed to a servlet container such as Tomcat if that’s your preference.</p><p>There is also a comprehensive Java API from which you can create an embedded WireMock server and configure as required.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>WireMockServer wireMockServer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> WireMockServer<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>wireMockServer<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span></code></pre></div><p>Finally, and more interesting from a Java testing perspective, WireMock provides JUnit integration using the @Rule annotation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Rule</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> WireMockRule wireMockRule <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> WireMockRule<span style=color:#f92672>(</span><span style=color:#ae81ff>9999</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><h3 id=key-features>Key features<a href=#key-features class=hanchor arialabel=Anchor>&#8983;</a></h3><p>I&rsquo;ll simply highlight the main features here, for more details the official <a href=http://wiremock.org/docs/>docs</a> are the place to go. The code samples here are taken directly from the official docs.</p><p><em>Stubbing</em> allows you to pre-define a canned response from the mock service that will be served when a request is made that matches a specific URL pattern.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>exactUrlOnly</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    stubFor<span style=color:#f92672>(</span>get<span style=color:#f92672>(</span>urlEqualTo<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/some/thing&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>willReturn</span><span style=color:#f92672>(</span>aResponse<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>withHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Content-Type&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;text/plain&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>withBody</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Hello world!&#34;</span><span style=color:#f92672>)));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    assertThat<span style=color:#f92672>(</span>testClient<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/some/thing&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>statusCode</span><span style=color:#f92672>(),</span> is<span style=color:#f92672>(</span><span style=color:#ae81ff>200</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    assertThat<span style=color:#f92672>(</span>testClient<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/some/thing/else&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>statusCode</span><span style=color:#f92672>(),</span> is<span style=color:#f92672>(</span><span style=color:#ae81ff>404</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><em>Verifying</em> allows you to prove that your application has interacted with the mock service in the way that you require it to.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>verify<span style=color:#f92672>(</span>postRequestedFor<span style=color:#f92672>(</span>urlEqualTo<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/verify/this&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>withHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Content-Type&#34;</span><span style=color:#f92672>,</span> equalTo<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;text/xml&#34;</span><span style=color:#f92672>)));</span>
</span></span></code></pre></div><p><em>Proxying</em> provides the ability for WireMock to selectively proxy requests to other hosts. This also supports the ability to record and playback interactions with the a service that it is proxying to. I found this a great way to create a base set of request mappings for use in development or to support your test suite.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>stubFor<span style=color:#f92672>(</span>get<span style=color:#f92672>(</span>urlMatching<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/other/service/.*&#34;</span><span style=color:#f92672>))</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>.</span><span style=color:#a6e22e>willReturn</span><span style=color:#f92672>(</span>aResponse<span style=color:#f92672>().</span><span style=color:#a6e22e>proxiedFrom</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;http://otherhost.com/approot&#34;</span><span style=color:#f92672>)));</span>
</span></span></code></pre></div><p>The ability to <em>simulate faults</em> is very useful, particularly when it comes to testing how resilient your application is to failures or inconsistent behaviour of its external dependencies. One example would be to add a delay to the interaction with the mock service to prove that your app behaves as expected.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>stubFor<span style=color:#f92672>(</span>get<span style=color:#f92672>(</span>urlEqualTo<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/delayed&#34;</span><span style=color:#f92672>)).</span><span style=color:#a6e22e>willReturn</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        aResponse<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>withStatus</span><span style=color:#f92672>(</span><span style=color:#ae81ff>200</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>.</span><span style=color:#a6e22e>withFixedDelay</span><span style=color:#f92672>(</span><span style=color:#ae81ff>2000</span><span style=color:#f92672>)));</span>
</span></span></code></pre></div><p><em>Stateful behaviour</em> provides a way to interact with the mock service and have it alter it’s state based on the interactions made. It allows WireMock to act as a state machine that can move through various states during a test to allow more complex scenarios to be modeled.</p><h2 id=conclusion>Conclusion<a href=#conclusion class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Through the use of a tool such as WireMock we were able to reduce our dependencies on the real service being available. This has not only been valuable during the execution of our automated test suite but has provided additional benefit during development with us realising an increase in developer productivity due to not being reliant on the “real” service being available and working as expected.</p><p>We have also been able to significantly improve the testability of the application, allowing us to create new tests for new features with less effort.</p><p>This has ultimately resulted in higher quality product being delivered more regularly and efficiently.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://nickebbitt.com/blog/2017/02/02/a-simplistic-approach-to-managing-app-config/><span class=button__icon>←</span>
<span class=button__text>A simplistic approach to managing app config</span></a></span>
<span class="button next"><a href=https://nickebbitt.com/blog/2016/11/29/jcrete-2016/><span class=button__text>JCrete 2016</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>