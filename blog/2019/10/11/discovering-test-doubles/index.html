<!doctype html><html lang=en><head><title>Discovering Test Doubles :: Nick Ebbitt</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I wrote most of the content for this post well over a year ago whilst working for Auto Trader. When I joined the company I landed in a team that was pretty unique compared to any I&amp;rsquo;d worked in before. The focus on quality and technical excellence was very high, there was a real focus on collaboration and I really started to get a feel for what it might be like in an XP team."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://nickebbitt.github.io/nickebbitt.com/blog/2019/10/11/discovering-test-doubles/><link rel=stylesheet href=https://nickebbitt.github.io/nickebbitt.com/styles.css><link rel="shortcut icon" href=https://nickebbitt.github.io/nickebbitt.com/img/theme-colors/orange.png><link rel=apple-touch-icon href=https://nickebbitt.github.io/nickebbitt.com/img/theme-colors/orange.png><meta name=twitter:card content="summary"><meta name=twitter:site content="nickebbitt"><meta name=twitter:creator content><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Discovering Test Doubles"><meta property="og:description" content="I wrote most of the content for this post well over a year ago whilst working for Auto Trader. When I joined the company I landed in a team that was pretty unique compared to any I&amp;rsquo;d worked in before. The focus on quality and technical excellence was very high, there was a real focus on collaboration and I really started to get a feel for what it might be like in an XP team."><meta property="og:url" content="https://nickebbitt.github.io/nickebbitt.com/blog/2019/10/11/discovering-test-doubles/"><meta property="og:site_name" content="Nick Ebbitt"><meta property="og:image" content="https://nickebbitt.github.io/nickebbitt.com/img/favicon/orange.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2019-10-11 00:00:00 +0000 UTC"></head><body class=orange><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/posts><div class=logo>Nick Ebbitt</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;â–¾</li><li><ul class=menu__dropdown><li><a href=/nickebbitt.com/about>About</a></li><li><a href=/nickebbitt.com/contact>Contact</a></li><li><a href=/nickebbitt.com/posts>Posts</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/nickebbitt.com/about>About</a></li><li><a href=/nickebbitt.com/contact>Contact</a></li><li><a href=/nickebbitt.com/posts>Posts</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://nickebbitt.github.io/nickebbitt.com/blog/2019/10/11/discovering-test-doubles/>Discovering Test Doubles</a></h1><div class=post-meta><time class=post-date>2019-10-11 ::</time></div><div class=post-content><div><p>I wrote most of the content for this post well over a year ago whilst working for <a href=https://careers.autotrader.co.uk/>Auto Trader</a>. When I joined the company I landed in a team that was pretty unique compared to any I&rsquo;d worked in before. The focus on quality and technical excellence was very high, there was a real focus on collaboration and I really started to get a feel for what it might be like in an XP team. In the short time I was on the team I learned a lot from some very smart people.</p><p>It&rsquo;s a bit of a long read but hopefully you find it useful and interesting. If you just care about what a test double is then go straight to <a href=#vocabulary>that section</a> and skip the background info.</p><p>I&rsquo;d love to hear any thoughts or experiences people have on this topic. Also any feedback on the content would be awesome.</p><p>I&rsquo;ve got doubts about the code examples used and really struggled with the section on mocks but after lots of umming and ahing I&rsquo;ve just decided to publish it as is. The way I see it is that it&rsquo;s just a waste of my time if I keep it hidden away on personal computer, what&rsquo;s the worst that could happen :)</p><h1 id=some-background>Some background<a href=#some-background class=hanchor arialabel=Anchor>&#8983;</a></h1><p>I started working with Java and object-oriented (OO) languages full-time just over 5 years ago. I made a concious decision to explore as many &ldquo;best-practice&rdquo; approaches to designing and implementing OO software as I could. This involved lots of research around the various techniques involved in creating well architected, <em>clean</em> software.</p><p>What I understand by well architected, <em>clean</em> software is:</p><blockquote><p>Software that is easy to understand (i.e. the design reveals the intent) and maintain (i.e. change).</p><p>Robert C. Martin</p></blockquote><p>This, however, is much easier said than done. After years of continuous trial and error there is still so much to learn. The number of times I look back at code I wrote 6 months ago, even 1 month ago (in fact, sometimes a few hours ago), and question my design choices is high. I think this is healthy though. We should always be challenging ourselves to become better developers.</p><p>When I was starting out developing OO software the idea of automated testing was quite alien to me. Previous to this I worked in an environment where testing was treated as a separate phase of the development process performed by a testing team. The only testing I carried out as a dev was manual or, at best, through writing throwaway test harnesses to exercise the code I had written. Looking back this feels so wrong but at the time it was my norm, and hindsight is a wonderful thing.</p><blockquote><p>Testing is all about getting feedback on software.</p><p>xUnit Test Patterns - Gerard Mezaros</p></blockquote><p>Around the same time I started to develop an appreciation for delivering software in a more <em>agile</em> way with the ideas behind <a href=https://en.wikipedia.org/wiki/Extreme_programming>eXtreme Programming</a> resonating strongly with me. The desire for ever shorter feedback loops in the development cycle and emphasis on Test Driven Development (TDD) helped me realise that without automated tests it would be very difficult, if not impossible, to incrementally evolve a software system with any level of confidence. Following a good few years of writing automated tests and practicing continuous integration it just seems like a no-brainer.</p><blockquote><p>When a class does not depend on any other classes, testing it is relatively straightforward.</p><p>xUnit Test Patterns - Gerard Mezaros</p></blockquote><p>Another reality that dawned on me more recently was that the design of these tests is as important to the overall understanding and maintainability of the software as the production code. There is definitely a skill to writing good tests and, while writing tests for a simple class or function with no dependencies is relatively straightforward, as soon as we tackle a more complex body of code, with one or more dependencies, things become a bit trickier.</p><p>To tackle this complexity it is common practice to reach for a mocking framework such as <a href=http://site.mockito.org/>Mockito</a>. Mocking frameworks enable developers to &ldquo;mock&rdquo; dependencies in their tests with ease but this can come at a cost, and it is a cost that I have felt first hand.</p><p>Mocking frameworks make it very convenient to &ldquo;mock&rdquo; dependencies in our tests and because of this I found myself mocking them without really thinking about the reasons why. The cost that materialised in my tests was that their intent became less clear making them difficult to understand what they are actually trying to achieve. I noticed that many tests would become quite complicated and the scope of the unit being tested became less clear.</p><p>This point is also pertintent where there is a desire for tests to provide a form of documentation for a system. If the tests aren&rsquo;t clear then their value significantly decreases.</p><p>Most of the time when using a mocking framework we aren&rsquo;t actually creating mocks. The term &ldquo;mock&rdquo; has become slang for test double so it&rsquo;s very easy to gloss over the fact that we are making use of various different types of test double.</p><p>Interestingly, the term &ldquo;mock&rdquo; is commonly used as a verb. We&rsquo;ll say things like &ldquo;we need to mock this out&rdquo; or &ldquo;we&rsquo;re going to need to do some mocking in this test&rdquo;.</p><blockquote><p>When all you have is a mocking framework, everything looks like a mock!</p><p>Me</p></blockquote><p>Prior to joining Auto Trader I used Mockito extensively in my tests. It was one of first tools I picked up when I started to learn TDD and write automated tests in Java. Then, all of a sudden, I was dropped into a code base where a concious decision had been made not use a mocking framework, instead all test doubles were hand rolled. Instead of seeing &ldquo;mock&rdquo; everywhere, I was now seeing terms such as dummy, stub, fake, as well as mock. Now don&rsquo;t get me wrong, I knew of these terms but being able to create my own dummies and stubs wasn&rsquo;t something that came naturally. Through using Mockito I&rsquo;d totally glossed over the details. In many ways having access to tools & frameworks such as Mockito is great as I felt like I became productive with automated testing fairly quickly. With hindsight it also had its problems, for example, without a second thought I would &ldquo;mock&rdquo; a collaborator required by my test.</p><blockquote><p>Easiness will eventually slow you down</p><p>Simple Made Easy - Rich Hickey</p></blockquote><p>So while mocking frameworks do make it easier to test our software I believe we also need to consider the incidental complexity that comes with them. If we don&rsquo;t take care to understand the tools we are using and the implications of the choices we make, the cost could be that we make choices that seem easier at the expense of longer term complexity.</p><p>Now we have some context let&rsquo;s get to the main focus of this post which is to explore the techniques available to us for writing simple, maintainable, and therefore <em>clean</em>, tests. We will focus on the trickier side of writing automated tests where we need to consider dependencies. In particular we will focus on the use of <em>test doubles</em> in place of those dependencies to verify the behaviour of a system. Through this we will understand the fundamental building blocks that we can use (and mocking frameworks also use) to test code that depends on other code.</p><p>With this knowledge we will have a better understanding of when to use a <em>test double</em> and importantly which type of <em>test double</em> we need, whether that is via a mocking framework or rolling our own.</p><h1 id=vocabulary>Vocabulary<a href=#vocabulary class=hanchor arialabel=Anchor>&#8983;</a></h1><p>First, let&rsquo;s define some of the concepts we&rsquo;ll be exploring and the vocabulary we&rsquo;ll be using. The following definitions have been collected from various leaders in this space over the past 20 years.</p><h2 id=system-under-test>System Under Test<a href=#system-under-test class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The system under test (SUT), or test subject, is&mldr;</p><blockquote><p>short for &ldquo;whatever thing we are testing&rdquo; and is always defined from the perspective of the test.</p><p><a href=http://xunitpatterns.com/SUT.html>Gerard Mezaros</a></p></blockquote><h2 id=unit-test>Unit test<a href=#unit-test class=hanchor arialabel=Anchor>&#8983;</a></h2><p>A low-level fast running test, usually written by a developer, focusing on a small part of the software system, that verifies some expectations about it.</p><p>But, what is a unit?</p><p>There are differing opinions of what a unit is but the one I adhere to and we&rsquo;ll use for the purposes of this talk is nicely described by Martin Fowler&mldr;</p><blockquote><p>Although I start with the notion of the unit being a class, I often take a bunch of closely related classes and treat them as a single unit.</p><p><a href=https://martinfowler.com/bliki/UnitTest.html>Martin Fowler</a></p></blockquote><h2 id=collaborator>Collaborator<a href=#collaborator class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Something that the test subject depends on, also known as a dependency. I will use these terms interchangeably.</p><blockquote><p>An individual class or a large-grained component on which the system under test (SUT) depends.</p><p><a href=http://xunitpatterns.com/DOC.html>Gerard Mezaros</a></p></blockquote><h2 id=test-double>Test double<a href=#test-double class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The term <em>test double</em> is a play on the term <em>stunt double</em> from the film industry. The idea being that we have body doubles that will stand in for the real actors. They will look the same and act similarly but they are not the real thing.</p><blockquote><p>Test Double is a generic term for any case where you replace a production object for testing purposes.</p><p>Martin Fowler - Mocks Aren&rsquo;t Stubs</p></blockquote><p>There are various types of test double and we will cover in these in more detail next.</p><h1 id=test-doubles>Test Doubles<a href=#test-doubles class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Now we have a bit of background and some high-level testing vocabulary to work with, using an example we&rsquo;ll explore the different types of test double.</p><p>When reading up about this topic, I encountered a various descriptions of the different test doubles with subtle differences. As with a lot of things in tech, opinions differ. The descriptions I provide here aren&rsquo;t my own, they come from leaders in the field such as <a href=http://xunitpatterns.com/>Gerard Mezaros</a>, <a href=https://8thlight.com/blog/uncle-bob/2014/05/14/TheLittleMocker.html>Robert Martin</a> and <a href=https://martinfowler.com/articles/mocksArentStubs.html>Martin Fowler</a></p><p>The are five main types of test double:</p><ul><li>Dummy</li><li>Stub</li><li>Spy</li><li>Mock</li><li>Fake</li></ul><p>The following examples test the algorithm for a notification service. Here&rsquo;s the API:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NotificationService</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> User user<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   NotificationService<span style=color:#f92672>(</span>User user<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> user<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>process</span><span style=color:#f92672>(</span>Notification notification<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>The job of the <code>NotificationService</code> is to determine whether the notification can be published for the user. A boolean is returned that represents whether a notification has been published or not.</p><p>While unit testing this we don&rsquo;t want to send real notifications. The delivery of real notifications will be performed by an external 3rd party system (e.g. AWS SNS or GCM) and for unit testing purposes we don&rsquo;t want to concern ourselves with this dependency. Amongst other things, using a real notification service introduces latency, non-determinism and of course the cost of using the service. If we are running the unit tests mutliple times a day, we want them to be quick, repeatable and we definitely don&rsquo;t expect them to have a direct financial impact to the business.</p><p>Therefore, instead of <code>process</code> depending on a real implementation of a notification, it depends on the concept of a notification. This is represented by the <code>Notification</code> interface.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Notification</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   Result <span style=color:#a6e22e>publish</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p><code>publish</code> returns a <code>Result</code>, which is an enum representing successful publish, or otherwise, of the notification.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>enum</span> Result <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    SUCCESS<span style=color:#f92672>,</span> FAIL
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>With this in mind, let&rsquo;s now take a look at our first test double.</p><h2 id=dummy>Dummy<a href=#dummy class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The simplest of all test doubles is the dummy (or dummy object).</p><blockquote><p>Dummy objects are passed around but never actually used. Usually they are just used to fill parameter lists.</p><p><a href=https://martinfowler.com/articles/mocksArentStubs.html>Martin Fowler</a></p></blockquote><p>Importantly, if a dummy was used in a test we would expect it to fail as this would be unexpected behaviour and we should be thinking about using another type of test double.</p><p>In respect of our notification service example, to publish a notification, the user must be authorised. If they are not, we need to ensure that a notification has not been published. The last thing we want is any old user sending out notifications and running up a bill with our favourite cloud provider.</p><p>In the context of our test, one way to ensure that a notification isn&rsquo;t sent when a request is made by an unauthorised user is to use a dummy notification. We need to supply a notification because the API requires it however we don&rsquo;t expect it to be used.</p><p>One option here is to simply pass null instead of an object to play the role of the dummy notification.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>notification_not_processed_when_user_is_unauthorised</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> NotificationService testSubject
</span></span><span style=display:flex><span>            <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NotificationService<span style=color:#f92672>(</span>unauthorisedUser<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    assertFalse<span style=color:#f92672>(</span>testSubject<span style=color:#f92672>.</span><span style=color:#a6e22e>process</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>This will work as if there any interactions with the dummy (or in this case <code>null</code>) notification then the test should blow up due to a <code>NullPointerException</code>. This isn&rsquo;t very obvious though and if a test fails because of it we&rsquo;ll need to perform a few mental hops to work out what&rsquo;s gone wrong. Also, I like code to be simple and express its intent.</p><p>I want the tests to speak to me so let&rsquo;s create a dummy object to serve that purpose.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DummyNotification</span> <span style=color:#66d9ef>implements</span> Notification <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>   Result <span style=color:#a6e22e>publish</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;This should not be called!&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Using an IDE (IntelliJ for me) we can quite quickly create a simple dummy implementation of the <code>Notification</code> interface. The <code>DummyNotification</code> will throw an exception if an attempt is made to publish it. This allows us to write a test that will fail if there are any unintended interactions with the notification whilst processing it for an unauthorised user.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>notification_not_processed_when_user_is_unauthorised</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> NotificationService testSubject
</span></span><span style=display:flex><span>            <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NotificationService<span style=color:#f92672>(</span>unauthorisedUser<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    assertFalse<span style=color:#f92672>(</span>testSubject<span style=color:#f92672>.</span><span style=color:#a6e22e>process</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> DummyNotification<span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>An alternative, if we&rsquo;re using Java 8 or later, is to simply pass a lambda as the <code>Notification</code> interface meets the contract for the <a href=https://docs.oracle.com/javase/8/docs/api/java/util/function/Supplier.html><code>Supplier</code></a> functional interface.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>notification_not_processed_when_user_is_unauthorised</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> NotificationService testSubject
</span></span><span style=display:flex><span>            <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NotificationService<span style=color:#f92672>(</span>unauthorisedUser<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Notification dummyNotification <span style=color:#f92672>=</span> <span style=color:#f92672>()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;This should not be called&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>};</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    assertFalse<span style=color:#f92672>(</span>testSubject<span style=color:#f92672>.</span><span style=color:#a6e22e>process</span><span style=color:#f92672>(</span>dummyNotification<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>This is nice as the expectations are clear in the test and we&rsquo;re able to do away with the extra class we created for the dummy notification, although we&rsquo;ll need to repeat this pattern wherever we want to use an equivalent double. It will depend on the context but it&rsquo;s a nice option if you want to use it. If you prefer, you could inline the lamba however I think giving it a name improves the readability of the test.</p><p>So that&rsquo;s a dummy, nice and simple but not very clever. Preferably we wouldn&rsquo;t want to put too much effort into creating a dummy for our tests. Also, if we are using lots of dummies there may be a problem with our design, for example the system under test having too many responsibilities.</p><p>While dummies are relatively quick and easy, their use is limited. A dummy won&rsquo;t help us to test the other scenarios that the <code>NotificationService</code> must support. One way we can do this is through the use of another test double, the Stub.</p><h2 id=stub>Stub<a href=#stub class=hanchor arialabel=Anchor>&#8983;</a></h2><p>So what is a Stub? Martin Fowler&rsquo;s description covers it nicely.</p><blockquote><p>Stubs provide canned answers to calls made during the test, usually not responding at all to anything outside what&rsquo;s programmed in for the test.</p><p><a href=https://martinfowler.com/bliki/TestDouble.html>Martin Fowler</a></p></blockquote><p>You may have noticed the use of <code>unauthorisedUser()</code> and <code>authorisedUser()</code> in the tests so far and wondered where they had come from. They are in fact stubs that we&rsquo;ve already been using on the quiet. These stubs are hard wired with the result allowing us to create types named very specifically to represent each of an authorised and unauthorised user.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UnauthorisedUserStub</span> <span style=color:#66d9ef>implements</span> User <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> User <span style=color:#a6e22e>unauthorisedUser</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> UnauthorisedUserStub<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>authorise</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AuthorisedUserStub</span> <span style=color:#66d9ef>implements</span> User <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> User <span style=color:#a6e22e>authorisedUser</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> AuthorisedUserStub<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>authorise</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>The nice thing about these stubs is that they can easily be shared across many tests, and when you see them being used their purpose is very clear.</p><p>Alternatively, switching back to the <code>Notification</code>, we may want to create a stub that&rsquo;s a bit more flexible.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NotificationStub</span> <span style=color:#66d9ef>implements</span> Notification <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Result result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   NotificationStub<span style=color:#f92672>(</span>Result result<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>publish</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>When we create this stub, we proivde the <code>Result</code> that we want it to return. This is known as a programmable stub.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>process_succeeds_when_user_is_authorised_and_notification_is_successful</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>final</span> NotificationStub successfulNotificationStub <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NotificationStub<span style=color:#f92672>(</span>Result<span style=color:#f92672>.</span><span style=color:#a6e22e>SUCCESS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>final</span> NotificationService testSubject <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NotificationService<span style=color:#f92672>(</span>authorisedUser<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   assertTrue<span style=color:#f92672>(</span>testSubject<span style=color:#f92672>.</span><span style=color:#a6e22e>process</span><span style=color:#f92672>(</span>successfulNotificationStub<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>process_fails_when_user_is_authorised_but_notification_fails</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>final</span> NotificationStub failedNotificationStub <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NotificationStub<span style=color:#f92672>(</span>Result<span style=color:#f92672>.</span><span style=color:#a6e22e>FAIL</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>final</span> NotificationService testSubject <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NotificationService<span style=color:#f92672>(</span>authorisedUser<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   assertFalse<span style=color:#f92672>(</span>testSubject<span style=color:#f92672>.</span><span style=color:#a6e22e>process</span><span style=color:#f92672>(</span>failedNotificationStub<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>We now know how to provide a stub to stand in for a collaborator and ask it to supply canned answers when it&rsquo;s interacted with but this doesn&rsquo;t guarantee that a call was made to the collaborator. Maybe the implementation just happened to pass the test. If we want to be sure that our test subject did infact use the collaborator in its algorithm then we need the help of another test double, the spy.</p><h2 id=spy>Spy<a href=#spy class=hanchor arialabel=Anchor>&#8983;</a></h2><p>The <em>spy</em> test double gives us a way to implement behaviour verification, that is, a way of verifying the iteractions of the test subject with a collaborator.</p><p>In the reliable words of Martin Fowler&mldr;</p><blockquote><p>Spies are stubs that also record some information based on how they were called.</p><p><a href=https://martinfowler.com/bliki/TestDouble.html>Martin Fowler</a></p></blockquote><p>A spy provides a way to capture information about how the test subject interacted with it, for example, the number of invocations or even the actual arguments used in a method call.</p><p>To create a spy we need to roll a slightly different implementation of the <code>Notification</code> interface.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NotificationSpy</span> <span style=color:#66d9ef>implements</span> Notification <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Result result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> publishWasCalled <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    NotificationSpy<span style=color:#f92672>(</span>Result result<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>publish</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        publishWasCalled <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>publishWasCalled</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> publishWasCalled<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Now, as well as returning a stubbed <code>Result</code>, when <code>publish</code> is called we record the fact in a boolean flag. This allows us to perform a verification against the flag in our test.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>process_succeeds_when_user_is_authorised_and_notification_is_successful</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   NotificationSpy successfulNotificationSpy <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NotificationSpy<span style=color:#f92672>(</span>Result<span style=color:#f92672>.</span><span style=color:#a6e22e>SUCCESS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>final</span> NotificationService testSubject <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NotificationService<span style=color:#f92672>(</span>authorisedUser<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   assertTrue<span style=color:#f92672>(</span>testSubject<span style=color:#f92672>.</span><span style=color:#a6e22e>process</span><span style=color:#f92672>(</span>successfulNotificationSpy<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>   assertTrue<span style=color:#f92672>(</span>successfulNotificationSpy<span style=color:#f92672>.</span><span style=color:#a6e22e>sendWasCalled</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>This is nice, the test is now speaking to us and the intent is obvious.</p><p>There is a flaw though in this implementation as if <code>publish</code> was called multiple times we wouldn&rsquo;t know. As there is a cost associated with publishing real notifications it&rsquo;s definitely a behaviour with undesirable side-effects.</p><p>A minor change to the our spy allows us to verify that <code>publish</code> is called once and only once.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NotificationSpy</span> <span style=color:#66d9ef>implements</span> Notification <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Result result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> publishWasCalledCount <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    NotificationSpy<span style=color:#f92672>(</span>Result result<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>publish</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        publishWasCalledCount<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>publishWasCalledCount</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> publishWasCalledCount<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Our test can then verify the number of calls made to <code>publish</code> that have been recorded against the spy.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>process_succeeds_when_user_is_authorised_and_notification_is_successful</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   NotificationSpy successfulNotificationSpy <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NotificationSpy<span style=color:#f92672>(</span>Result<span style=color:#f92672>.</span><span style=color:#a6e22e>SUCCESS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>final</span> NotificationService testSubject <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NotificationService<span style=color:#f92672>(</span>authorisedUser<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   assertTrue<span style=color:#f92672>(</span>testSubject<span style=color:#f92672>.</span><span style=color:#a6e22e>process</span><span style=color:#f92672>(</span>successfulNotificationSpy<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>   assertEquals<span style=color:#f92672>(</span>notificationSpy<span style=color:#f92672>.</span><span style=color:#a6e22e>sendWasCalledCount</span><span style=color:#f92672>(),</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>With the spy test double covered we&rsquo;ll move swiftly on to the next, the mock.</p><h2 id=mock>Mock<a href=#mock class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Until recently I would have referred to all of the above as a mock! This was ultimately the motivation for this post. I wanted to discover the real meaning behind the term mock, and more generally test doubles.</p><p>Mocks are&mldr;</p><blockquote><p>&mldr;objects pre-programmed with expectations which form a specification of the calls they are expected to receive.</p><p><a href=https://martinfowler.com/articles/mocksArentStubs.html>Martin Fowler</a></p></blockquote><p>In essence, this means that the mock has the knowledge of how the test subject should interact with it and is able to verify it.</p><p>When it comes to creating our own mock object things become a bit trickier. We need to write more code in our test double meaning its complexity is going to rise and there will be a greater maintenance overhead. With this in mind, we&rsquo;ll have a go anyway.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NotificationMock</span> <span style=color:#66d9ef>implements</span> Notification <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Result result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> actualPublishCallCount <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    NotificationMock<span style=color:#f92672>(</span>Result result<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> expectedPublishCallCount<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>expectedPublishCallCount</span> <span style=color:#f92672>=</span> expectedPublishCallCount<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> Result <span style=color:#a6e22e>publish</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        actualPublishCallCount<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>verify</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        assertTrue<span style=color:#f92672>(</span>actualPublishCallCount<span style=color:#f92672>,</span> expectedPublishCallCount<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>We can then construct our mock and pre-program it with the expectation of a single call being made to the <code>publish</code> method.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>process_succeeds_when_user_is_authorised_and_notification_is_successful</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   NotificationMock successfulNotificationMock <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NotificationMock<span style=color:#f92672>(</span>Result<span style=color:#f92672>.</span><span style=color:#a6e22e>SUCCESS</span><span style=color:#f92672>,</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>final</span> NotificationService testSubject <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NotificationService<span style=color:#f92672>(</span>authorisedUser<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   assertTrue<span style=color:#f92672>(</span>testSubject<span style=color:#f92672>.</span><span style=color:#a6e22e>process</span><span style=color:#f92672>(</span>successfulNotificationMock<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>   successfulNotificationMock<span style=color:#f92672>.</span><span style=color:#a6e22e>verify</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>In some ways though the test has become less obvious. One way to improve this is to provide a builder for the mock so we can create it using a more fluent API e.g.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>new</span> NotificationMockBuilder<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span><span style=color:#a6e22e>withResult</span><span style=color:#f92672>(</span>Result<span style=color:#f92672>.</span><span style=color:#a6e22e>SUCCESS</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>.</span><span style=color:#a6e22e>withExpectedPublishCallCount</span><span style=color:#f92672>(</span><span style=color:#ae81ff>1</span><span style=color:#f92672>);</span>
</span></span></code></pre></div><p>At this point though it probably makes sense to reach for a mocking framework such as <a href=https://site.mockito.org/>Mockito</a>. The power of Mockito (and other mocking frameworks) removes a lot of the complexity and code we have to write and maintain ourselves.</p><p>Of course with great power comes great responsibility but, having read this far, we&rsquo;ll hopefully be more informed when reaching for the more powerful tools that are available.</p><h2 id=fake>Fake<a href=#fake class=hanchor arialabel=Anchor>&#8983;</a></h2><p>When we want to verify the behaviour of the test subject but depending on the real implementation of a collaborator is not possible or desirable, one option is to use a <em>fake</em> object.</p><blockquote><p>Fake objects actually have working implementations, but usually take some shortcut which makes them not suitable for production</p><p><a href=https://martinfowler.com/articles/mocksArentStubs.html>Martin Fowler</a></p></blockquote><p>A good example is where you choose to use an in-memory database instead of the real thing. This helps to remove the dependency on the real database being available as well being much more efficient. If the database is a key/value store then an even simpler Map based implementation could fit the bill and provide even greater efficiency. After all, unit tests should be fast.</p><p>To demonstrate with a simple, possibly unlikely, example we&rsquo;ll create a fake <code>User</code>. The fake <code>User</code> will have a working implementation of the <code>authorise</code> method that will only allow notifications to be sent for users with a name starting with <em>&ldquo;Nick&rdquo;</em>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FakeUser</span> <span style=color:#66d9ef>implements</span> User <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> String name<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>FakeUser</span><span style=color:#f92672>(</span>String name<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> name<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>authorise</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> name<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Nick&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>This can then be used in our example tests as an alernative to the authorised user stub.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>process_succeeds_when_user_is_authorised_and_notification_is_successful</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   User authorisedUser <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FakeUser<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Nick Ebbitt&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>   NotificationStub successfulNotificationStub <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NotificationStub<span style=color:#f92672>(</span>Result<span style=color:#f92672>.</span><span style=color:#a6e22e>SUCCESS</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   NotificationService testSubject <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NotificationService<span style=color:#f92672>(</span>authorisedUser<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   assertTrue<span style=color:#f92672>(</span>testSubject<span style=color:#f92672>.</span><span style=color:#a6e22e>process</span><span style=color:#f92672>(</span>successfulNotificationStub<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>And with that we have covered the test doubles I set out to in this post. The Dummy, Stub, Spy, Mock and finally the Fake.</p><h1 id=wrapping-up>Wrapping Up<a href=#wrapping-up class=hanchor arialabel=Anchor>&#8983;</a></h1><p>First of all, if you&rsquo;ve made it this far then thanks for reading, I hope you found it worthwhile :)</p><blockquote><p>Know your test doubles, not everything is a &ldquo;mock&rdquo;.</p></blockquote><p>Hopefully, if not already, you now have a better understanding of the different types of test doubles that can be used to help us test your code.</p><blockquote><p>Try to write clean tests that speak to you.</p></blockquote><p>With this shared understanding and vocabulary, as developers we can have better conversations around the design of our tests.</p><blockquote><p>When using a mocking framework, think about the test doubles in play.</p></blockquote><p>This should mean we are better placed to choose the right test double for our use-case.</p><blockquote><p>Where it makes sense, use the power of a mocking framework to help write your tests, but do so with a good understanding of how they work.</p></blockquote><p>We&rsquo;ll also be more aware of the test-cases that genuinely benefit from using a mocking framework, and when you do you&rsquo;ll understand the work they are doing for you under the hood.</p><blockquote><p>Agree on practices & principles with your team, be consistent.</p></blockquote><p>Regardless of whether you roll your own doubles, use a mocking framework or a apply a mixture of both I believe its really valuable to discuss and agree the approach and style as a team. The value of a codebase with a consistent and coherent style shouldn&rsquo;t be underestimated.</p><h1 id=references>References<a href=#references class=hanchor arialabel=Anchor>&#8983;</a></h1><ul><li><a href=http://xunitpatterns.com/>xUnit Patterns</a> - Gerard Mezaros</li><li><a href=https://martinfowler.com/bliki/TestDouble.html>Test Double</a> - Martin Fowler</li><li><a href=https://martinfowler.com/bliki/UnitTest.html>Unit Test</a> - Martin Fowler</li><li><a href=https://martinfowler.com/articles/mocksArentStubs.html>Mocks Aren&rsquo;t Stubs</a> - Martin Fowler</li><li><a href=https://8thlight.com/blog/uncle-bob/2014/05/14/TheLittleMocker.html>The Little Mocker</a> - Robert C. Martin</li></ul></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://nickebbitt.github.io/nickebbitt.com/blog/2021/04/29/debugging-a-jaeger-memory-issue/><span class=button__icon>â†</span>
<span class=button__text>Debugging a Jaeger memory issue</span></a></span>
<span class="button next"><a href=https://nickebbitt.github.io/nickebbitt.com/blog/2019/06/07/jalba-2019/><span class=button__text>JAlba 2019</span>
<span class=button__icon>â†’</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>Â© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/nickebbitt.com/bundle.min.js></script></div></body></html>